# Настройка нескольких доменов на одном сервере

## Как это работает

✅ **Домен настраивается автоматически** из конфига деплоя при каждом деплое.

✅ **На одном сервере можно разместить несколько доменов** - каждый домен получает свой nginx virtual host.

## Процесс деплоя

1. **Создай конфиг деплоя** с указанием домена:
   - Название: любое (например, `production`, `staging`)
   - Домен: `example.com` (или любой другой домен)
   - GitHub репозиторий: `username/repo`
   - Сервер: выбери VM

2. **Нажми "Задеплоить фронтенд"**:
   - Код клонируется в `/var/www/{domain}/`
   - Собирается через `npm install` и `npm run build`
   - Копируется в `/var/www/{domain}/html/`
   - Создаётся nginx конфиг для этого домена
   - Nginx перезагружается

3. **Домен автоматически настраивается в nginx**:
   - Конфиг создаётся в `/etc/nginx/sites-available/{domain_safe}`
   - Активируется через симлинк в `/etc/nginx/sites-enabled/`
   - Все домены на сервере работают параллельно

## Структура на сервере

```
/var/www/
├── example.com/
│   └── html/          # Собранные файлы фронтенда
├── another-domain.com/
│   └── html/          # Другой проект
└── ...

/etc/nginx/sites-available/
├── example_com        # Конфиг для example.com
├── another_domain_com # Конфиг для another-domain.com
└── ...

/etc/nginx/sites-enabled/
├── example_com        # Симлинк → sites-available/example_com
├── another_domain_com # Симлинк → sites-available/another_domain_com
└── ...
```

## Настройка DNS

Для работы домена нужно настроить DNS:

1. **Добавь A-запись** в DNS провайдере:
   ```
   example.com → IP_АДРЕС_СЕРВЕРА
   ```

2. **Или для тестирования** добавь в `/etc/hosts`:
   ```
   IP_АДРЕС_СЕРВЕРА example.com
   ```

## Примеры использования

### Пример 1: Несколько проектов на одном сервере

1. Создай конфиг `project1` с доменом `project1.example.com`
2. Создай конфиг `project2` с доменом `project2.example.com`
3. Оба конфига привяжи к одной VM
4. Задеплой оба проекта
5. Оба домена будут работать на одном сервере

### Пример 2: Production и Staging

1. Создай конфиг `production` с доменом `app.example.com`
2. Создай конфиг `staging` с доменом `staging.example.com`
3. Оба на одном сервере или на разных
4. Каждый домен работает независимо

## Важно

- ✅ Домен из конфига используется автоматически - не нужно ничего настраивать вручную
- ✅ Каждый домен получает свой nginx virtual host
- ✅ Все домены на сервере работают параллельно
- ✅ При деплое существующего домена конфиг обновляется автоматически
- ✅ Можно использовать один сервер для множества доменов

## Проверка

После деплоя проверь:

1. **Логи деплоя** показывают:
   - `✅ nginx настроен для домена {domain}`
   - Список всех активных доменов на сервере

2. **На сервере** проверь:
   ```bash
   # Все активные домены
   ls -la /etc/nginx/sites-enabled/
   
   # Конфиг конкретного домена
   cat /etc/nginx/sites-available/{domain_safe}
   
   # Проверка nginx
   sudo nginx -t
   ```

3. **Доступность**:
   - По домену: `http://example.com` (если DNS настроен)
   - По IP: `http://IP_АДРЕС` (покажет первый домен или default)

## Troubleshooting

### Домен не открывается

1. Проверь DNS: `ping example.com` должен показать IP сервера
2. Проверь nginx: `sudo nginx -t` на сервере
3. Проверь логи: `sudo tail -f /var/log/nginx/{domain}_error.log`

### Несколько доменов конфликтуют

- Каждый домен должен иметь уникальное имя в конфиге
- Nginx автоматически выбирает правильный конфиг по `server_name`

### Нужно удалить домен

- Удали конфиг из `/etc/nginx/sites-enabled/`
- Перезагрузи nginx: `sudo systemctl reload nginx`
- Или удали конфиг деплоя из деплойера
