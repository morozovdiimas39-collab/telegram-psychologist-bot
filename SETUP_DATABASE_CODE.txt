========================================
–§–£–ù–ö–¶–ò–Ø setup-database - –ü–û–õ–ù–´–ô –ö–û–î (–û–ë–ù–û–í–õ–ï–ù–û)
========================================

–ò–ú–Ø –§–£–ù–ö–¶–ò–ò: setup-database
–û–ü–ò–°–ê–ù–ò–ï: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ VM —Å PostgreSQL
–°–†–ï–î–ê –í–´–ü–û–õ–ù–ï–ù–ò–Ø: Python 3.11
–¢–û–ß–ö–ê –í–•–û–î–ê: index.handler
–¢–ê–ô–ú–ê–£–¢: 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç) - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 600 —Å–µ–∫—É–Ω–¥
–ü–ê–ú–Ø–¢–¨: 256 MB

–í–ê–ñ–ù–û: –≠—Ç–æ—Ç –∫–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –∫–ª—é—á–æ–º —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞!

–û–ë–ù–û–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–æ–ª–µ–π –¥–ª—è Serial Console
- –õ–æ–≥–∏–Ω: root / –ü–∞—Ä–æ–ª—å: root123
- –õ–æ–≥–∏–Ω: ubuntu / –ü–∞—Ä–æ–ª—å: ubuntu123

========================================
–ö–û–î –§–£–ù–ö–¶–ò–ò (index.py):
========================================

import json
import os
import psycopg2
from psycopg2.extras import RealDictCursor
import requests
import time


def handler(event: dict, context) -> dict:
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ VM —Å PostgreSQL –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞–∫ –æ–±—â–µ–π –ë–î"""
    method = event.get('httpMethod', 'POST')

    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type'
            },
            'body': '',
            'isBase64Encoded': False
        }

    try:
        body = json.loads(event.get('body', '{}'))
        db_name = body.get('db_name', 'deployer')
        db_user = body.get('db_user', 'deployer_user')
        db_password = body.get('db_password')  # –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
        
        logs = []
        logs.append("üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ VM —Å PostgreSQL –¥–ª—è –æ–±—â–µ–π –ë–î...")
        logs.append("")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
        if not db_password:
            import secrets
            db_password = secrets.token_urlsafe(16)
            logs.append(f"üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø–∞—Ä–æ–ª—å –ë–î: {db_password}")
            logs.append("   ‚ö†Ô∏è –°–û–•–†–ê–ù–ò –ï–ì–û! –û–Ω –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω.")
            logs.append("")
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        dsn = os.environ.get('DATABASE_URL')  # –í—Ä–µ–º–µ–Ω–Ω–∞—è –ë–î –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        schema = os.environ.get('MAIN_DB_SCHEMA', 'public')
        oauth_token = os.environ.get('YANDEX_CLOUD_TOKEN')
        service_account_id = os.environ.get('YANDEX_SERVICE_ACCOUNT_ID')  # ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è 'iss'
        service_account_key_id = os.environ.get('YANDEX_SERVICE_ACCOUNT_KEY_ID')  # ID –∫–ª—é—á–∞ –¥–ª—è 'kid'
        service_account_private_key = os.environ.get('YANDEX_SERVICE_ACCOUNT_PRIVATE_KEY')
        
        # –ü–æ–ª—É—á–∞–µ–º IAM —Ç–æ–∫–µ–Ω
        logs.append("üîê –ü–æ–ª—É—á–∞—é IAM —Ç–æ–∫–µ–Ω...")
        
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è 'iss', –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º ID –∫–ª—é—á–∞
        if service_account_id:
            issuer_id = service_account_id
        else:
            issuer_id = service_account_key_id
        
        if service_account_key_id and service_account_private_key:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
            logs.append("   –ò—Å–ø–æ–ª—å–∑—É—é –∫–ª—é—á —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞...")
            try:
                import jwt
                import time
                
                # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
                # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–ª—é—á –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ PEM
                private_key = service_account_private_key.strip()
                
                # –ó–∞–º–µ–Ω—è–µ–º –ª–∏—Ç–µ—Ä–∞–ª—å–Ω—ã–µ \n –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ (–µ—Å–ª–∏ –∫–ª—é—á –±—ã–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞)
                private_key = private_key.replace('\\n', '\n')
                
                # –£–±–∏—Ä–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ Yandex Cloud, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if 'PLEASE DO NOT REMOVE' in private_key:
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ —Å –∫–ª—é—á–æ–º
                    lines = private_key.split('\n')
                    key_lines = []
                    in_key = False
                    for line in lines:
                        if '-----BEGIN PRIVATE KEY-----' in line:
                            in_key = True
                        if in_key:
                            key_lines.append(line)
                        if '-----END PRIVATE KEY-----' in line:
                            break
                    private_key = '\n'.join(key_lines)
                
                # –ï—Å–ª–∏ –∫–ª—é—á –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É (–±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤), —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –µ–≥–æ
                if '\n' not in private_key or not private_key.startswith('-----BEGIN'):
                    # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                    key_content = private_key.replace(' ', '').replace('\n', '').replace('\r', '')
                    
                    # –£–±–∏—Ä–∞–µ–º BEGIN/END –º–∞—Ä–∫–µ—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
                    if '-----BEGIN' in key_content:
                        key_content = key_content.split('-----BEGIN PRIVATE KEY-----')[1]
                    if '-----END' in key_content:
                        key_content = key_content.split('-----END PRIVATE KEY-----')[0]
                    
                    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –ø–æ 64 —Å–∏–º–≤–æ–ª–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç PEM)
                    formatted_key = '\n'.join([key_content[i:i+64] for i in range(0, len(key_content), 64)])
                    private_key = f"-----BEGIN PRIVATE KEY-----\n{formatted_key}\n-----END PRIVATE KEY-----"
                else:
                    # –ö–ª—é—á —É–∂–µ –≤ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                    if not private_key.startswith('-----BEGIN PRIVATE KEY-----'):
                        # –î–æ–±–∞–≤–ª—è–µ–º BEGIN, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                        if 'BEGIN' not in private_key:
                            private_key = f"-----BEGIN PRIVATE KEY-----\n{private_key}"
                    
                    if not private_key.endswith('-----END PRIVATE KEY-----'):
                        # –î–æ–±–∞–≤–ª—è–µ–º END, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                        if 'END' not in private_key:
                            private_key = f"{private_key}\n-----END PRIVATE KEY-----"
                    
                    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫
                    lines = private_key.split('\n')
                    cleaned_lines = []
                    for line in lines:
                        if line.strip():  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                            cleaned_lines.append(line.strip())
                    private_key = '\n'.join(cleaned_lines)
                    
                    # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ BEGIN –∏ END –Ω–∞ –º–µ—Å—Ç–µ
                    if not private_key.startswith('-----BEGIN PRIVATE KEY-----'):
                        private_key = f"-----BEGIN PRIVATE KEY-----\n{private_key}"
                    if not private_key.endswith('-----END PRIVATE KEY-----'):
                        private_key = f"{private_key}\n-----END PRIVATE KEY-----"
                
                # –°–æ–∑–¥–∞—ë–º JWT —Ç–æ–∫–µ–Ω –¥–ª—è —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
                # –í–ê–ñ–ù–û: –î–ª—è Yandex Cloud:
                # - 'iss' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (ajea2l0hjh86sa9a3g08)
                # - 'kid' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ID –∫–ª—é—á–∞ (ajeke7hvv73d03siopbo)
                now = int(time.time())
                payload = {
                    'aud': 'https://iam.api.cloud.yandex.net/iam/v1/tokens',
                    'iss': issuer_id,  # ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
                    'iat': now,
                    'exp': now + 3600
                }
                
                logs.append(f"   –°–æ–∑–¥–∞—é JWT —Å issuer: {issuer_id} (ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞)")
                logs.append(f"   –ò—Å–ø–æ–ª—å–∑—É—é key ID: {service_account_key_id} (ID –∫–ª—é—á–∞)")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —á–µ—Ä–µ–∑ cryptography
                try:
                    from cryptography.hazmat.primitives import serialization
                    from cryptography.hazmat.backends import default_backend
                    
                    # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á —á–µ—Ä–µ–∑ cryptography –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    try:
                        key_obj = serialization.load_pem_private_key(
                            private_key.encode('utf-8'),
                            password=None,
                            backend=default_backend()
                        )
                        # –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ PEM –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
                        private_key_pem = key_obj.private_bytes(
                            encoding=serialization.Encoding.PEM,
                            format=serialization.PrivateFormat.PKCS8,
                            encryption_algorithm=serialization.NoEncryption()
                        ).decode('utf-8')
                        private_key = private_key_pem
                        logs.append("   ‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ cryptography")
                    except Exception as crypto_error:
                        logs.append(f"   ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ cryptography: {str(crypto_error)[:100]}")
                        logs.append("   –ü—Ä–æ–±—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á –Ω–∞–ø—Ä—è–º—É—é...")
                        # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –∏—Å—Ö–æ–¥–Ω—ã–º –∫–ª—é—á–æ–º
                except ImportError:
                    # cryptography —É–∂–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤—ã—à–µ, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                    pass
                
                # –°–æ–∑–¥–∞—ë–º JWT —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ PS256
                # Yandex Cloud —Ç—Ä–µ–±—É–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º PS256, –∞ –Ω–µ RS256
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ 'kid' –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ JWT (—Ç—Ä–µ–±—É–µ—Ç—Å—è Yandex Cloud) - —ç—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ID –∫–ª—é—á–∞
                headers = {'kid': service_account_key_id}  # ID –∫–ª—é—á–∞ –¥–ª—è 'kid'
                jwt_token = jwt.encode(payload, private_key, algorithm='PS256', headers=headers)
                
                logs.append("   ‚úÖ JWT —Ç–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω")
                
                iam_resp = requests.post(
                    'https://iam.api.cloud.yandex.net/iam/v1/tokens',
                    json={'jwt': jwt_token},
                    timeout=10
                )
            except ImportError:
                logs.append("   ‚ö†Ô∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ jwt –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
                return {
                    'statusCode': 500,
                    'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                    'body': json.dumps({
                        'error': '–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω—É–∂–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ PyJWT',
                        'hint': '–î–æ–±–∞–≤—å PyJWT>=2.8.0 –≤ requirements.txt –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π YANDEX_CLOUD_TOKEN (OAuth —Ç–æ–∫–µ–Ω)'
                    }),
                    'isBase64Encoded': False
                }
            except jwt.InvalidKeyError as e:
                logs.append(f"   ‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–ª—é—á–∞: {str(e)}")
                return {
                    'statusCode': 500,
                    'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                    'body': json.dumps({
                        'error': f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞: {str(e)}',
                        'hint': '–£–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–ª—é—á –≤ —Ñ–æ—Ä–º–∞—Ç–µ PEM –∏ –≤–∫–ª—é—á–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ -----BEGIN PRIVATE KEY----- –∏ -----END PRIVATE KEY-----'
                    }),
                    'isBase64Encoded': False
                }
            except Exception as e:
                import traceback
                error_details = traceback.format_exc()
                logs.append(f"   ‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è JWT: {str(e)}")
                return {
                    'statusCode': 500,
                    'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                    'body': json.dumps({
                        'error': f'–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–∞: {str(e)}',
                        'details': error_details,
                        'hint': '–ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –∏ ID –∫–ª—é—á–∞. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞, –∞ –Ω–µ ID –∫–ª—é—á–∞ (–µ—Å–ª–∏ ID –∫–ª—é—á–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)'
                    }),
                    'isBase64Encoded': False
                }
        elif oauth_token:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º OAuth —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            logs.append("   –ò—Å–ø–æ–ª—å–∑—É—é OAuth —Ç–æ–∫–µ–Ω...")
            iam_resp = requests.post(
                'https://iam.api.cloud.yandex.net/iam/v1/tokens',
                json={'yandexPassportOauthToken': oauth_token},
                timeout=10
            )
        else:
            return {
                'statusCode': 500,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps({
                    'error': '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω YANDEX_CLOUD_TOKEN –∏–ª–∏ –∫–ª—é—á–∏ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞',
                    'hint': '–ù—É–∂–µ–Ω –ª–∏–±–æ YANDEX_CLOUD_TOKEN (OAuth —Ç–æ–∫–µ–Ω), –ª–∏–±–æ YANDEX_SERVICE_ACCOUNT_ID (ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞) + YANDEX_SERVICE_ACCOUNT_KEY_ID (ID –∫–ª—é—á–∞) + YANDEX_SERVICE_ACCOUNT_PRIVATE_KEY (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ —Ñ–æ—Ä–º–∞—Ç–µ PEM)'
                }),
                'isBase64Encoded': False
            }
        
        if iam_resp.status_code != 200:
            error_text = iam_resp.text
            logs.append(f"   ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è IAM —Ç–æ–∫–µ–Ω–∞: {iam_resp.status_code}")
            logs.append(f"   –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {error_text}")
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –æ—à–∏–±–∫–∏ 401
            if iam_resp.status_code == 401:
                hint = "–í–æ–∑–º–æ–∂–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–≤–µ—Ä–Ω—ã–π ID –∫–ª—é—á–∞. –ü–æ–ø—Ä–æ–±—É–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤–º–µ—Å—Ç–æ ID –∫–ª—é—á–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π YANDEX_SERVICE_ACCOUNT_KEY_ID"
            else:
                hint = "–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–∞ –∏ ID"
            
            raise Exception(f'IAM token error: {iam_resp.status_code} - {error_text}. {hint}')
        
        iam_token = iam_resp.json()['iamToken']
        headers = {'Authorization': f'Bearer {iam_token}'}
        
        # –ü–æ–ª—É—á–∞–µ–º folder_id
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É–∫–∞–∑–∞–Ω –ª–∏ folder_id –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        folder_id = os.environ.get('YANDEX_FOLDER_ID')
        
        if folder_id:
            logs.append(f"‚òÅÔ∏è –ò—Å–ø–æ–ª—å–∑—É—é folder_id –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è: {folder_id}")
        else:
            logs.append("‚òÅÔ∏è –ü–æ–ª—É—á–∞—é folder...")
            
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å folder_id –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫ folders
            folders_resp = requests.get(
                'https://resource-manager.api.cloud.yandex.net/resource-manager/v1/folders',
                headers=headers,
                timeout=10
            )
            
            if folders_resp.status_code == 200:
                folders = folders_resp.json().get('folders', [])
                if folders:
                    folder_id = folders[0]['id']
                    logs.append(f"‚úÖ Folder ID –ø–æ–ª—É—á–µ–Ω –Ω–∞–ø—Ä—è–º—É—é: {folder_id}")
            
            # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ clouds
            if not folder_id:
                logs.append("   –ü—Ä–æ–±—É—é –ø–æ–ª—É—á–∏—Ç—å folder —á–µ—Ä–µ–∑ clouds...")
                clouds_resp = requests.get(
                    'https://resource-manager.api.cloud.yandex.net/resource-manager/v1/clouds',
                    headers=headers,
                    timeout=10
                )
                
                if clouds_resp.status_code != 200:
                    error_text = clouds_resp.text
                    logs.append(f"   ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è clouds: {clouds_resp.status_code} - {error_text}")
                    raise Exception(f'Failed to get clouds: {error_text}. –í–æ–∑–º–æ–∂–Ω–æ, —É —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–ª–∞–∫–æ–≤. –î–æ–±–∞–≤—å —Ä–æ–ª—å "viewer" –∏–ª–∏ "editor" –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–±–ª–∞–∫–∞.')
                
                clouds = clouds_resp.json().get('clouds', [])
                if not clouds:
                    logs.append("   ‚ö†Ô∏è –û–±–ª–∞–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
                    raise Exception('No clouds found. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —É —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–ª–∞–∫–æ–≤ (—Ä–æ–ª—å "viewer" –∏–ª–∏ "editor" –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–±–ª–∞–∫–∞).')
                
                cloud_id = clouds[0]['id']
                logs.append(f"   ‚úÖ Cloud ID: {cloud_id}")
                
                folders_resp = requests.get(
                    f'https://resource-manager.api.cloud.yandex.net/resource-manager/v1/folders?cloudId={cloud_id}',
                    headers=headers,
                    timeout=10
                )
                
                if folders_resp.status_code != 200:
                    error_text = folders_resp.text
                    logs.append(f"   ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è folders: {folders_resp.status_code} - {error_text}")
                    raise Exception(f'Failed to get folders: {error_text}')
                
                folders = folders_resp.json().get('folders', [])
                if not folders:
                    logs.append("   ‚ö†Ô∏è Folders –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
                    raise Exception('No folders found. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ –æ–±–ª–∞–∫–µ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–∞—Ç–∞–ª–æ–≥ (folder).')
                
                folder_id = folders[0]['id']
                logs.append(f"‚úÖ Folder ID: {folder_id}")
        
        if not folder_id:
            raise Exception('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å folder_id. –£–∫–∞–∂–∏ –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è YANDEX_FOLDER_ID –∏–ª–∏ –¥–æ–±–∞–≤—å –ø—Ä–∞–≤–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–ª–∞–∫–æ–≤.')
        
        # –ü–æ–ª—É—á–∞–µ–º subnet_id
        logs.append("üåê –ü–æ–ª—É—á–∞—é —Å–µ—Ç—å...")
        nets_resp = requests.get(
            f'https://vpc.api.cloud.yandex.net/vpc/v1/networks?folderId={folder_id}',
            headers=headers,
            timeout=10
        )
        
        networks = nets_resp.json().get('networks', [])
        
        if not networks:
            create_net = requests.post(
                'https://vpc.api.cloud.yandex.net/vpc/v1/networks',
                headers={**headers, 'Content-Type': 'application/json'},
                json={'folderId': folder_id, 'name': 'default-network'},
                timeout=10
            )
            
            if create_net.status_code not in [200, 201]:
                raise Exception(f'Failed to create network: {create_net.text}')
            
            network_id = create_net.json()['id']
        else:
            network_id = networks[0]['id']
        
        subnets_resp = requests.get(
            f'https://vpc.api.cloud.yandex.net/vpc/v1/subnets?folderId={folder_id}',
            headers=headers,
            timeout=10
        )
        
        subnets = subnets_resp.json().get('subnets', [])
        
        subnet_id = None
        for subnet in subnets:
            if subnet.get('zoneId') == 'ru-central1-a':
                subnet_id = subnet['id']
                break
        
        if not subnet_id:
            create_subnet = requests.post(
                'https://vpc.api.cloud.yandex.net/vpc/v1/subnets',
                headers={**headers, 'Content-Type': 'application/json'},
                json={
                    'folderId': folder_id,
                    'name': 'subnet-a',
                    'networkId': network_id,
                    'zoneId': 'ru-central1-a',
                    'v4CidrBlocks': ['10.128.0.0/24']
                },
                timeout=10
            )
            
            if create_subnet.status_code not in [200, 201]:
                raise Exception(f'Failed to create subnet: {create_subnet.text}')
            
            subnet_id = create_subnet.json()['id']
        
        logs.append(f"‚úÖ –°–µ—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")
        logs.append("")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SSH –∫–ª—é—á–∏ –¥–ª—è VM
        from cryptography.hazmat.primitives.asymmetric import rsa
        from cryptography.hazmat.primitives import serialization
        
        private_key = rsa.generate_private_key(public_exponent=65537, key_size=2048)
        private_pem = private_key.private_bytes(
            encoding=serialization.Encoding.PEM,
            format=serialization.PrivateFormat.TraditionalOpenSSL,
            encryption_algorithm=serialization.NoEncryption()
        ).decode()
        
        public_key = private_key.public_key()
        public_ssh = public_key.public_bytes(
            encoding=serialization.Encoding.OpenSSH,
            format=serialization.PublicFormat.OpenSSH
        ).decode()
        
        # Cloud-init —Å–∫—Ä–∏–ø—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PostgreSQL
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è VM —Å timestamp, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        import time
        timestamp = int(time.time())
        vm_name = f'db-server-{timestamp}'
        cloud_init = f"""#cloud-config
# –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é —á–µ—Ä–µ–∑ SSH –∏ Serial Console
ssh_pwauth: true
disable_root: false

users:
  - name: ubuntu
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: $6$rounds=4096$salt$hashed_password_here
    ssh-authorized-keys:
      - {public_ssh}
  - name: root
    lock_passwd: false
    passwd: $6$rounds=4096$salt$hashed_password_here

package_update: true
package_upgrade: true

packages:
  - postgresql
  - postgresql-contrib
  - ufw
  - net-tools

write_files:
  - path: /var/log/postgresql-setup.log
    permissions: '0644'
    content: |
      PostgreSQL setup log started
      
runcmd:
  - |
    echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Serial Console..." | tee -a /var/log/postgresql-setup.log
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–æ–ª–µ–π –¥–ª—è –≤—Ö–æ–¥–∞
    echo "root:root123" | chpasswd
    echo "ubuntu:ubuntu123" | chpasswd
    # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Ö–æ–¥ root —á–µ—Ä–µ–∑ –ø–∞—Ä–æ–ª—å –≤ SSH
    sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config 2>/dev/null || true
    sed -i 's/PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config 2>/dev/null || true
    # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é –≤ SSH
    sed -i 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config 2>/dev/null || true
    sed -i 's/PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config 2>/dev/null || true
    sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config 2>/dev/null || true
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ getty –¥–ª—è Serial Console
    systemctl enable serial-getty@ttyS0.service 2>/dev/null || true
    systemctl start serial-getty@ttyS0.service 2>/dev/null || true
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ SSH –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    systemctl restart sshd 2>/dev/null || systemctl restart ssh 2>/dev/null || true
    echo "–ü–∞—Ä–æ–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:" | tee -a /var/log/postgresql-setup.log
    echo "  root / root123" | tee -a /var/log/postgresql-setup.log
    echo "  ubuntu / ubuntu123" | tee -a /var/log/postgresql-setup.log
  - |
    echo "=== –ù–∞—á–∞–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PostgreSQL ===" | tee -a /var/log/postgresql-setup.log
    date | tee -a /var/log/postgresql-setup.log
  - |
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..." | tee -a /var/log/postgresql-setup.log
    apt-get update -y | tee -a /var/log/postgresql-setup.log
    apt-get install -y postgresql postgresql-contrib ufw net-tools | tee -a /var/log/postgresql-setup.log
    echo "–ü–∞–∫–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã" | tee -a /var/log/postgresql-setup.log
  - |
    echo "–ó–∞–ø—É—Å–∫ PostgreSQL..." | tee -a /var/log/postgresql-setup.log
    systemctl start postgresql | tee -a /var/log/postgresql-setup.log
    systemctl enable postgresql | tee -a /var/log/postgresql-setup.log
    sleep 3
    systemctl status postgresql | tee -a /var/log/postgresql-setup.log
  - |
    echo "–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." | tee -a /var/log/postgresql-setup.log
    sudo -u postgres psql <<EOF | tee -a /var/log/postgresql-setup.log
    CREATE DATABASE {db_name};
    CREATE USER {db_user} WITH PASSWORD '{db_password}';
    GRANT ALL PRIVILEGES ON DATABASE {db_name} TO {db_user};
    ALTER USER {db_user} CREATEDB;
    \\q
    EOF
    echo "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞" | tee -a /var/log/postgresql-setup.log
  - |
    echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π..." | tee -a /var/log/postgresql-setup.log
    PG_VERSION=$(ls /etc/postgresql/ 2>/dev/null | head -n 1)
    echo "–ù–∞–π–¥–µ–Ω–∞ –≤–µ—Ä—Å–∏—è PostgreSQL: $PG_VERSION" | tee -a /var/log/postgresql-setup.log
    if [ -n "$PG_VERSION" ]; then
      echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ postgresql.conf..." | tee -a /var/log/postgresql-setup.log
      sudo sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/" /etc/postgresql/$PG_VERSION/main/postgresql.conf
      sudo sed -i "s/listen_addresses = 'localhost'/listen_addresses = '*'/" /etc/postgresql/$PG_VERSION/main/postgresql.conf
      echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ pg_hba.conf..." | tee -a /var/log/postgresql-setup.log
      echo "host    all    all    0.0.0.0/0    md5" | sudo tee -a /etc/postgresql/$PG_VERSION/main/pg_hba.conf
      echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PostgreSQL..." | tee -a /var/log/postgresql-setup.log
      systemctl restart postgresql
      sleep 2
      echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ PostgreSQL..." | tee -a /var/log/postgresql-setup.log
      systemctl status postgresql | tee -a /var/log/postgresql-setup.log
    else
      echo "–û–®–ò–ë–ö–ê: –í–µ—Ä—Å–∏—è PostgreSQL –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!" | tee -a /var/log/postgresql-setup.log
    fi
  - |
    echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall..." | tee -a /var/log/postgresql-setup.log
    ufw allow 5432/tcp | tee -a /var/log/postgresql-setup.log
    ufw --force enable | tee -a /var/log/postgresql-setup.log
    ufw status | tee -a /var/log/postgresql-setup.log
  - |
    echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 5432..." | tee -a /var/log/postgresql-setup.log
    sleep 3
    netstat -tlnp | grep 5432 | tee -a /var/log/postgresql-setup.log || ss -tlnp | grep 5432 | tee -a /var/log/postgresql-setup.log || echo "–ü–æ—Ä—Ç 5432 –Ω–µ –Ω–∞–π–¥–µ–Ω" | tee -a /var/log/postgresql-setup.log
  - |
    echo "=== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ===" | tee -a /var/log/postgresql-setup.log
    date | tee -a /var/log/postgresql-setup.log
    cat /var/log/postgresql-setup.log
"""
        
        # –°–æ–∑–¥–∞—ë–º VM
        logs.append("üñ•Ô∏è –°–æ–∑–¥–∞—é VM –¥–ª—è PostgreSQL...")
        vm_payload = {
            "folderId": folder_id,
            "name": vm_name,
            "zoneId": "ru-central1-a",
            "platformId": "standard-v3",
            "resourcesSpec": {
                "memory": "2147483648",  # 2 GB
                "cores": "2",
                "coreFraction": "20"
            },
            "metadata": {
                "user-data": cloud_init,
                "serial-port-enable": "1"
            },
            "bootDiskSpec": {
                "mode": "READ_WRITE",
                "autoDelete": True,
                "diskSpec": {
                    "size": "21474836480",  # 20 GB
                    "typeId": "network-hdd",
                    "imageId": "fd8kdq6d0p8sij7h5qe3"  # Ubuntu 22.04
                }
            },
            "networkInterfaceSpecs": [{
                "subnetId": subnet_id,
                "primaryV4AddressSpec": {
                    "oneToOneNatSpec": {
                        "ipVersion": "IPV4"
                    }
                }
            }],
            "schedulingPolicy": {
                "preemptible": False
            }
        }
        
        response = requests.post(
            'https://compute.api.cloud.yandex.net/compute/v1/instances',
            headers={**headers, 'Content-Type': 'application/json'},
            json=vm_payload,
            timeout=30
        )
        
        if response.status_code not in [200, 201]:
            raise Exception(f'VM creation failed: {response.text}')
        
        result = response.json()
        yandex_vm_id = result['metadata']['instanceId']
        logs.append(f"‚úÖ VM —Å–æ–∑–¥–∞–Ω–∞: {yandex_vm_id}")
        logs.append("‚è≥ –ñ–¥—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è IP –∞–¥—Ä–µ—Å–∞...")
        
        # –ñ–¥—ë–º –ø–æ–ª—É—á–µ–Ω–∏—è IP –∞–¥—Ä–µ—Å–∞
        ip_address = None
        for i in range(30):
            time.sleep(2)
            vm_info = requests.get(
                f'https://compute.api.cloud.yandex.net/compute/v1/instances/{yandex_vm_id}',
                headers=headers,
                timeout=10
            )
            
            if vm_info.status_code == 200:
                vm_data = vm_info.json()
                interfaces = vm_data.get('networkInterfaces', [])
                if interfaces:
                    nat_address = interfaces[0].get('primaryV4Address', {}).get('oneToOneNat', {})
                    if nat_address.get('address'):
                        ip_address = nat_address['address']
                        break
            
            if i % 5 == 0:
                logs.append(f"   –û–∂–∏–¥–∞–Ω–∏–µ IP... ({i*2} —Å–µ–∫)")
        
        if not ip_address:
            raise Exception('Failed to get VM IP address')
        
        logs.append(f"‚úÖ IP –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω: {ip_address}")
        logs.append("")
        logs.append("‚è≥ –ñ–¥—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL (—ç—Ç–æ –∑–∞–π–º—ë—Ç 1-2 –º–∏–Ω—É—Ç—ã)...")
        
        # –ñ–¥—ë–º –ø–æ–∫–∞ PostgreSQL —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω
        database_url = f"postgresql://{db_user}:{db_password}@{ip_address}:5432/{db_name}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
        postgres_ready = False
        for attempt in range(60):  # 60 –ø–æ–ø—ã—Ç–æ–∫ –ø–æ 5 —Å–µ–∫—É–Ω–¥ = 5 –º–∏–Ω—É—Ç
            try:
                test_conn = psycopg2.connect(
                    database_url,
                    connect_timeout=5
                )
                test_conn.close()
                postgres_ready = True
                logs.append(f"‚úÖ PostgreSQL –≥–æ—Ç–æ–≤! (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1})")
                break
            except Exception as e:
                if attempt % 10 == 0:
                    logs.append(f"   –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è... ({attempt + 1}/60)")
                time.sleep(5)
        
        if not postgres_ready:
            logs.append("‚ö†Ô∏è PostgreSQL –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ VM —Å–æ–∑–¥–∞–Ω–∞")
            logs.append("   –ü–æ–¥–æ–∂–¥–∏ –µ—â—ë 2-3 –º–∏–Ω—É—Ç—ã –∏ –ø—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é")
        
        logs.append("")
        logs.append("=" * 60)
        logs.append("‚úÖ VM —Å PostgreSQL —Å–æ–∑–¥–∞–Ω–∞!")
        logs.append("")
        logs.append(f"üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:")
        logs.append(f"   VM ID: {yandex_vm_id}")
        logs.append(f"   IP –∞–¥—Ä–µ—Å: {ip_address}")
        logs.append(f"   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {db_name}")
        logs.append(f"   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {db_user}")
        logs.append(f"   –ü–∞—Ä–æ–ª—å: {db_password}")
        logs.append("")
        logs.append(f"üîó DATABASE_URL:")
        logs.append(f"   {database_url}")
        logs.append("")
        logs.append("=" * 60)
        logs.append("")
        logs.append("üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:")
        logs.append("   1. –°–∫–æ–ø–∏—Ä—É–π DATABASE_URL –≤—ã—à–µ")
        logs.append("   2. –î–æ–±–∞–≤—å –µ–≥–æ –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é DATABASE_URL –≤–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–µ–ø–ª–æ–π–µ—Ä–∞")
        logs.append("   3. –ü—Ä–∏–º–µ–Ω–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î —á–µ—Ä–µ–∑ –¥–µ–ø–ª–æ–π–µ—Ä")
        logs.append("")
        
        return {
            'statusCode': 200,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({
                'success': True,
                'logs': logs,
                'vm_id': yandex_vm_id,
                'ip_address': ip_address,
                'database_url': database_url,
                'db_name': db_name,
                'db_user': db_user,
                'db_password': db_password,
                'message': 'VM —Å PostgreSQL —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ'
            }),
            'isBase64Encoded': False
        }
        
    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        print(f"ERROR: {str(e)}")
        print(f"Traceback: {error_details}")
        
        return {
            'statusCode': 500,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({
                'error': str(e),
                'details': error_details,
                'logs': logs if 'logs' in locals() else []
            }),
            'isBase64Encoded': False
        }


def get_folder_id(iam_token):
    """–ü–æ–ª—É—á–∏—Ç—å folder_id –∏–∑ Yandex Cloud"""
    headers = {'Authorization': f'Bearer {iam_token}'}
    
    clouds_resp = requests.get(
        'https://resource-manager.api.cloud.yandex.net/resource-manager/v1/clouds',
        headers=headers,
        timeout=10
    )
    
    if clouds_resp.status_code != 200:
        raise Exception(f'Failed to get clouds: {clouds_resp.text}')
    
    clouds = clouds_resp.json().get('clouds', [])
    if not clouds:
        raise Exception('No clouds found')
    
    cloud_id = clouds[0]['id']
    
    folders_resp = requests.get(
        f'https://resource-manager.api.cloud.yandex.net/resource-manager/v1/folders?cloudId={cloud_id}',
        headers=headers,
        timeout=10
    )
    
    folders = folders_resp.json().get('folders', [])
    if not folders:
        raise Exception('No folders found')
    
    return folders[0]['id']


========================================
–ó–ê–í–ò–°–ò–ú–û–°–¢–ò (requirements.txt):
========================================

psycopg2-binary>=2.9.0
requests>=2.31.0
cryptography>=41.0.0
PyJWT>=2.8.0


========================================
–ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø:
========================================

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï:
- YANDEX_SERVICE_ACCOUNT_ID: ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (ajea2l0hjh86sa9a3g08)
- YANDEX_SERVICE_ACCOUNT_KEY_ID: ID –∫–ª—é—á–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (ajeke7hvv73d03siopbo)
- YANDEX_SERVICE_ACCOUNT_PRIVATE_KEY: –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ —Ñ–æ—Ä–º–∞—Ç–µ PEM (–ø–æ–ª–Ω—ã–π –∫–ª—é—á –∏–∑ —Ñ–∞–π–ª–∞ SERVICE_ACCOUNT_PRIVATE_KEY.txt)
- YANDEX_FOLDER_ID: ID –∫–∞—Ç–∞–ª–æ–≥–∞ (b1gga4kkbv0csaelq94p)

–û–ü–¶–ò–û–ù–ê–õ–¨–ù–´–ï:
- YANDEX_CLOUD_TOKEN: OAuth —Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–ª—é—á —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞)
- DATABASE_URL: –í—Ä–µ–º–µ–Ω–Ω–∞—è –ë–î –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)
- MAIN_DB_SCHEMA: –°—Ö–µ–º–∞ –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: public)


========================================
–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –û–ë–ù–û–í–õ–ï–ù–ò–Æ –§–£–ù–ö–¶–ò–ò:
========================================

1. –û—Ç–∫—Ä–æ–π –∫–æ–Ω—Å–æ–ª—å Yandex Cloud: https://console.cloud.yandex.ru/
2. –ü–µ—Ä–µ–π–¥–∏ –≤ —Ä–∞–∑–¥–µ–ª "Cloud Functions"
3. –ù–∞–π–¥–∏ —Ñ—É–Ω–∫—Ü–∏—é "setup-database"
4. –ù–∞–∂–º–∏ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –∏–ª–∏ "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é"
5. –°–∫–æ–ø–∏—Ä—É–π –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ backend/setup-database/index.py –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞ —Ñ—É–Ω–∫—Ü–∏–∏
6. –£–±–µ–¥–∏—Å—å, —á—Ç–æ requirements.txt —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
   - psycopg2-binary>=2.9.0
   - requests>=2.31.0
   - cryptography>=41.0.0
   - PyJWT>=2.8.0
7. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
   - YANDEX_SERVICE_ACCOUNT_ID
   - YANDEX_SERVICE_ACCOUNT_KEY_ID
   - YANDEX_SERVICE_ACCOUNT_PRIVATE_KEY
   - YANDEX_FOLDER_ID
8. –°–æ—Ö—Ä–∞–Ω–∏ –∏ –æ–ø—É–±–ª–∏–∫—É–π –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Ñ—É–Ω–∫—Ü–∏–∏
9. –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏, —É–¥–∞–ª–∏ —Å—Ç–∞—Ä—É—é VM (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ —Å–æ–∑–¥–∞–π –Ω–æ–≤—É—é —á–µ—Ä–µ–∑ –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏


========================================
–ü–ê–†–û–õ–ò –î–õ–Ø SERIAL CONSOLE:
========================================

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π VM —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º –∫–æ–¥–æ–º —Ñ—É–Ω–∫—Ü–∏–∏:

- –õ–æ–≥–∏–Ω: root
  –ü–∞—Ä–æ–ª—å: root123

- –õ–æ–≥–∏–Ω: ubuntu
  –ü–∞—Ä–æ–ª—å: ubuntu123

–≠—Ç–∏ –ø–∞—Ä–æ–ª–∏ –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ VM.


========================================
–ü–†–ò–ú–ï–ß–ê–ù–ò–Ø:
========================================

- –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è VM —Å timestamp (db-server-{timestamp})
- Cloud-init —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–µ—Ä—Å–∏—é PostgreSQL
- –í—Å–µ –ª–æ–≥–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PostgreSQL —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ /var/log/postgresql-setup.log
- Serial Console –≤–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (serial-port-enable: "1")
- PostgreSQL –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (–ø–æ—Ä—Ç 5432)
- Firewall (ufw) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç 5432
